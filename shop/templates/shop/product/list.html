{% extends 'shop/base.html' %}
{% load static %}

{% block title %}
    {% if category %}{{ category.name }}{% else %}Товары{% endif %}
{% endblock %}

{% block content %}
<!--<img src="{% static 'img/main_back.jpg' %}" style="position: absolute; width: 100%; margin-left: 0;">-->
<div id="sidebar-custom" style="z-index: 2;" xmlns="http://www.w3.org/1999/html">
    <div class="menu-btn">
  <div class="btn-line"></div>
  <div class="btn-line"></div>
  <div class="btn-line"></div>
</div>
<nav class="menu">
  <h1 style="display: flex; justify-content: center;">Каталог</h1>
  <ul class="menu-items">
    <li {% if not category %}class="selected"{% endif %}>
        <a href="{% url 'shop:product_list' %}">Все</a>
    </li>
    <li class="has-submenu">
        <a href="#">Мебель</a>
        <ul class="submenu submenu-right">
            {% for c in category_furniture %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
    <li class="has-submenu">
        <a href="#">Плитка керамическая</a>
                <ul class="submenu submenu-right">
            {% for c in category_tile %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
    <li class="has-submenu">
        <a href="#">Напольные покрытия</a>
        <ul class="submenu submenu-right">
            {% for c in category_flooring %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
    <li class="has-submenu">
        <a href="#">Обои</a>
                <ul class="submenu submenu-right">
            {% for c in category_wallpaper %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Интерьер</a>
        <ul class="submenu submenu-right">
            {% for c in category_interior %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Сантехника</a>
        <ul class="submenu submenu-right">
            {% for c in category_plumbing %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Лакокраска</a>
        <ul class="submenu submenu-right">
            {% for c in category_paintwork %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Инструмент</a>
        <ul class="submenu submenu-right">
            {% for c in category_instrument %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Настенные покрытия</a>
        <ul class="submenu submenu-right">
            {% for c in category_coverings %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Пиломатериалы, столярные изделия</a>
        <ul class="submenu submenu-right">
            {% for c in category_lumber %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
       <li class="has-submenu">
        <a href="#">Светильники</a>
        <ul class="submenu submenu-right">
            {% for c in category_lamps %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
       <li class="has-submenu">
        <a href="#">Строительные материалы</a>
        <ul class="submenu submenu-right">
            {% for c in category_build %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
       <li class="has-submenu">
        <a href="#">Сухие смеси</a>
        <ul class="submenu submenu-right">
            {% for c in category_mixes %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Двери</a>
        <ul class="submenu submenu-right">
            {% for c in category_doors %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
      <li class="has-submenu">
        <a href="#">Электротовары</a>
        <ul class="submenu submenu-right">
            {% for c in category_electrical %}
            <li class="list-subcategory">
                    <a href="{{ c.get_absolute_url }}" class="right-category">{{ c.name }}</a>
            </li>
            {% endfor %}
        </ul>
    </li>
  </ul>
</nav>
<script>
</script>
        {% if category %}
        <h3>Каталог</h3>
            <ul>
                <li {% if not category %}class="selected"{% endif %}>
                    <a href="{% url 'shop:product_list' %}">Все</a>
                </li>
                {% for c in category_main %}
                    <li {% if category.slug == c.slug %}class="selected"{% endif %}>
                        <a href="{{ c.get_absolute_url }}">{{ c.name }}</a>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
        <!-- Фильтр по цене -->
        <div class="wrapper">
            <header>
                <h2>Цена</h2>
            </header>
            <div class="price-input">
                <div class="field">
                    <span>от</span>
                    <input type="number" class="input-min" value="2500">
                </div>
                <div class="separator">-</div>
                <div class="field">
                    <span>до</span>
                    <input type="number" class="input-max" value="300000">
                </div>
            </div>
            <div class="slider">
                <div class="progress"></div>
            </div>
            <div class="range-input">
                <input type="range" class="range-min" min="0" max="500000" value="2500">
                <input type="range" class="range-max" min="0" max="500000" value="300000">
            </div>
        </div>

        <!-- Фильтр по цвету -->
        <div class="wrapper">
            <header>
                <h2>Цвет</h2>
            </header>
                <div class="filter-options">
                    {% for color in colors %}
                        <input type="checkbox" name="color[]" class="filter-checkbox" value="{{ color }}" id="color{{ forloop.counter }}">
                        <label for="color{{ forloop.counter }}">{{ color }}</label><br>
                    {% endfor %}
                </div>
        </div>

<!-- Фильтр по производителю -->
        <div class="wrapper">
            <header>
                <h2>Производитель</h2>
            </header>
                <div class="filter-options">
                    {% for manufacturer in manufacturers %}
                        <input type="checkbox" name="manufacturer[]" class="filter-checkbox" value="{{ manufacturer }}" id="manufacturer{{ forloop.counter }}">
                        <label for="manufacturer{{ forloop.counter }}">{{ manufacturer }}</label><br>
                    {% endfor %}
                </div>
        </div>

<!-- Фильтр по материалу -->
        <div class="wrapper">
            <header>
                <h2>Материал</h2>
            </header>
                <div class="filter-options">
                    {% for material in materials %}
                        <input type="checkbox" name="material[]" class="filter-checkbox" value="{{ material }}" id="material{{ forloop.counter }}">
                        <label for="material{{ forloop.counter }}">{{ material }}</label><br>
                    {% endfor %}
                </div>
        </div>

<!-- Фильтр по длине -->
        <div class="wrapper">
            <header>
                <h2>Длина</h2>
            </header>
                <div class="filter-options">
                    {% for length in lengths %}
                        <input type="checkbox" name="length[]" class="filter-checkbox" value="{{ length }}" id="length{{ forloop.counter }}">
                        <label for="length{{ forloop.counter }}">{{ length }}</label><br>
                    {% endfor %}
                </div>
        </div>

<!-- Фильтр по ширине -->
        <div class="wrapper">
            <header>
                <h2>Ширина</h2>
            </header>
                <div class="filter-options">
                    {% for width in widths %}
                        <input type="checkbox" name="width[]" class="filter-checkbox" value="{{ width }}" id="width{{ forloop.counter }}">
                        <label for="width{{ forloop.counter }}">{{ width }}</label><br>
                    {% endfor %}
                </div>
        </div>

<!-- Фильтр по высоте -->
        <div class="wrapper">
            <header>
                <h2>Высота</h2>
            </header>
                <div class="filter-options">
                    {% for height in heights %}
                        <input type="checkbox" name="height[]" class="filter-checkbox" value="{{ height }}" id="height{{ forloop.counter }}">
                        <label for="height{{ forloop.counter }}">{{ height }}</label><br>
                    {% endfor %}
                </div>
        </div>


</div>

    <div id="main" class="product-list">
        <h1 style="margin-bottom: 4%; width: 100%;">{% if category %}{{ category.name }}{% else %}Товары{% endif %}</h1>
        <div id="product-container">
            {% include 'shop/product/list_partial.html' %}
        </div>
    </div>
    <div class="modal" id="modal">
            <div class="modal__box">
                <button class="modal__box-btn" id="close-modal-btn">
                    <svg width="23" height="25" viewBox="0 0 23 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.09082 0.03125L22.9999 22.0294L20.909 24.2292L-8.73579e-05 2.23106L2.09082 0.03125Z"
                            fill="#333333" />
                        <path d="M0 22.0295L20.9091 0.314368L23 2.23125L2.09091 24.2294L0 22.0295Z" fill="#333333" />
                    </svg>
                </button>
                <h2>Чат с технической поддержкой "СОМ"</h2>
                    {% if user.is_authenticated %}
                        {% if request.user.is_authenticated and request.user.username != 'ahmat' %}
                            <div style="display:flex;">
                                <p>{{ user.lastname }}</p>
                                <p>{{ user.firstname }}</p>
                            </div>
                            <div class="chat__header">
                                <h1>
                                    Чат c {{ message.last_name }}
                                    {{ message.first_name }}
                                </h1>
                            </div>
                            {% for m in messages %}
                                {% if m.user.username == 'ahmat' %}
                                    <h3 class="message__admin">{{m.text}} {{m.time}}</h3>
                                    <br>
                                {% else %}
                                <div class="message__user__container">
                                    <h3 class="message__user__text">{{ m.text }} {{ m.time }}</h3>
                                    <br>
                                </div>
                                {% endif %}
                            {% endfor %}
                            <form class="chat-form" action="{% url 'chat:message' request.user.id %}" method="post">
                                {% csrf_token %}
                                <p>Введите сообщение:</p>
                                <div class="chat-input">
                                    <textarea class="review__input" type="text" placeholder="Текст..." name="message"></textarea>
                                    <button class="beauty-button" type="submit">Отправить сообщение</button>
                                </div>
                            </form>
                        {% elif request.user.username == 'ahmat' %}
                            <h2>Сообщения</h2>
                            {% for message in messages %}
                                <a href="{% url 'chat:chat_detail' message.id %}">
                                <div class="chat-detail">
                                    <div class="chat-detail__input">
                                        <h3 class="chat-detail__last-name">{{ message.user.last_name }}</h3>
                                        <h3>{{ message.user.first_name }}</h3>
                                    </div>
                                    <h3>{{ message.text }}</h3>
                                </div>
                                </a>
                            {% endfor %}
                        {% else %}
                            <h2>Для отправки сообщения администратору сначала авторизуйтесь</h2>
                        {% endif %}
                    {% endif %}
            </div>
        </div>
    <button id="open-modal-btn" class="open-modal-btn"></button>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.getElementById("open-modal-btn").addEventListener("click", function() {
            document.getElementById("modal").classList.add("open");
        });

        document.getElementById("close-modal-btn").addEventListener("click", function() {
            document.getElementById("modal").classList.remove("open");
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('modal').classList.remove('open');
            }
        });

        document.querySelector('#modal .modal__box').addEventListener('click', event => {
            event.is_ClickWithInModal = true;
        });

        function updateProductList() {
            let filters = {
                min_price: $('.input-min').val(),
                max_price: $('.input-max').val(),
                color: [],
                manufacturer: [],
                material: [],
                length: [],
                width: [],
                height: []
            };

            $('.filter-checkbox:checked').each(function() {
                let name = $(this).attr('name');
                let value = $(this).val();
                console.log("Name:", name, "Value:", value); // Отладочный вывод
                if (name.endsWith('[]')) {
                    name = name.slice(0, -2); // Убираем квадратные скобки из имени
                    if (filters[name] === undefined) {
                        filters[name] = []; // Проверяем, существует ли массив, если нет, создаем его
                    }
                    filters[name].push(value);
                } else {
                    filters[name] = value;
                }
            });

            $.ajax({
                url: '',
                type: 'GET',
                data: filters,
                success: function(data) {
                    $('#product-container').html(data);
                },
                error: function(xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        }

        function initializeSlider() {
            let minVal = parseInt($('.input-min').val()),
                maxVal = parseInt($('.input-max').val());

            $('.range-min').val(minVal);
            $('.range-max').val(maxVal);

            $('.progress').css({
                left: (minVal / $('.range-min').attr('max')) * 100 + '%',
                right: 100 - (maxVal / $('.range-max').attr('max')) * 100 + '%'
            });
        }

        $(document).on('input', '.price-input input', function() {
            updateProductList();
        });

        $(document).on('change', '.filter-checkbox', function() {
            updateProductList();
        });

        $('.range-input input').on('input', function() {
            let minVal = parseInt($('.range-min').val()),
                maxVal = parseInt($('.range-max').val());

            if (maxVal - minVal < 40000) {
                if ($(this).hasClass('range-min')) {
                    $('.range-min').val(maxVal - 40000);
                } else {
                    $('.range-max').val(minVal + 40000);
                }
            } else {
                $('.input-min').val(minVal);
                $('.input-max').val(maxVal);
                $('.progress').css({
                    left: (minVal / $('.range-min').attr('max')) * 100 + '%',
                    right: 100 - (maxVal / $('.range-max').attr('max')) * 100 + '%'
                });
                updateProductList();
            }
        });

        $(document).ready(function() {
            initializeSlider();
        });
        $('.filter-checkbox:checked').each(function() {
            let name = $(this).attr('name');
            let value = $(this).val();
            console.log("Name:", name, "Value:", value); // Отладочный вывод
            if (name.slice(-2) === '[]') {
                name = name.slice(0, -2); // Удалить квадратные скобки
                if (!filters[name]) {
                    filters[name] = []; // Создать массив, если он не существует
                }
                filters[name].push(value);
            } else {
                filters[name] = value; // Просто установить значение, если это не массив
            }
        });
        $(document).ready(function() {
            $(document).on('submit', '.chat-form', function(event) {
                event.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: form.serialize(),
                    success: function(response) {
                        console.log('Сообщение отправлено');
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                });
            });
        });
        var timer;
        var isPaused = false;

        $(window).on('wheel', function(){
            isPaused = true;
            clearTimeout(timer);
            timer = window.setTimeout(function(){
                isPaused = false;
            }, 1000);
        });

        window.setInterval(function(){
            if(!isPaused){
                $("#modal").scrollTop($("#modal")[0].scrollHeight);
            }
        }, 500);
            const menuBtn = document.querySelector('.menu-btn');
const menu = document.querySelector('.menu');

let menuOpen = false;
menuBtn.addEventListener('click', () => {
  if (!menuOpen) {
    menuBtn.classList.add('open');
    menu.classList.add('menu-open');
    menuOpen = true;
  } else {
    menuBtn.classList.remove('open');
    menu.classList.remove('menu-open');
    menuOpen = false;
  }
});
document.addEventListener('DOMContentLoaded', function() {
            const categories = document.querySelectorAll('.has-submenu');

            categories.forEach(function(category) {
                category.addEventListener('mouseenter', function() {
                    const submenu = this.querySelector('.submenu');
                    submenu.style.display = 'block';
                });

                category.addEventListener('mouseleave', function() {
                    const submenu = this.querySelector('.submenu');
                    submenu.style.display = 'none';
                });
            });
        });

        // Закрываем меню при клике на пункт
        document.querySelectorAll('.has-submenu > a').forEach(function(item) {
            item.addEventListener('click', function(event) {
                event.stopPropagation(); // Предотвращаем всплытие клика, чтобы меню не закрывалось сразу
            });
        });

        // Закрываем меню при клике вне его области
        document.addEventListener('click', function(event) {
            const menu = document.querySelector('.menu');
            if (!menu.contains(event.target)) {
                menu.classList.remove('active');
            }
        });
    </script>
{% endblock %}