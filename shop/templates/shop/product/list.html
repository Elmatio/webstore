{% extends 'shop/base.html' %}
{% load static %}

{% block title %}
    {% if category %}{{ category.name }}{% else %}Товары{% endif %}
{% endblock %}

{% block content %}
    <div id="sidebar-custom" style="z-index: 2;">
        <h3 style="color: #111111;">Каталог</h3>
        <ul>
            <li {% if not category %}class="selected"{% endif %}>
                    <a href="{% url 'shop:product_list' %}">Все</a>
            </li>
            {% for c in categories %}
                <li {% if category.slug == c.slug %}class="selected"{% endif %}>
                    <a href="{{ c.get_absolute_url }}">{{ c.name }}</a>
                </li>
            {% endfor %}
        </ul>
        <div class="wrapper">
            <header>
                <h2>Range price</h2>
                <p>Slider</p>
            </header>
            <div class="price-input">
                <div class="field">
                    <span>от</span>
                    <input type="number" class="input-min" value="2500">
                </div>
                <div class="separator">-</div>
                <div class="field">
                    <span>до</span>
                    <input type="number" class="input-max" value="300000">
                </div>
            </div>
            <div class="slider">
                <div class="progress"></div>
            </div>
            <div class="range-input">
                <input type="range" class="range-min" min="0" max="500000" value="2500">
                <input type="range" class="range-max" min="0" max="500000" value="300000">
            </div>
        </div>
        <form method="get">
            {{ filter.form.as_p }}
            <input type="submit" value="Применить фильтр">
        </form>
    </div>
    <div id="main" class="product-list" style="">
        <h1 style="margin-bottom: 10%; width: 100%;">{% if category %}{{ category.name }}{% else %}Товары{% endif %}</h1>
        {% for product in filter.qs %}
            <div class="item" style="padding-bottom: 0; position: relative;">
                    <a href="{{ product.get_absolute_url }}">
                        <img style="" src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}">
                    </a>
                <div style="margin-bottom: 1%; bottom: 30%; right: 25%; position: absolute;">
                <a class="wrapper-break" style="padding-right: 0; text-align: right;" href="{{ product.get_absolute_url }}">
                    {{ product.name }}
                </a>
                <br>
                <p style="text-align: right;">{{ product.price }} ₽</p>
                </div>
            </div>
        {% endfor %}
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function outputUpdate(vol) {
            var output = document.querySelector('#volume');
            output.value = vol;
            output.style.left = vol;
        }
        const rangeInput = document.querySelectorAll(".range-input input"),
        priceInput = document.querySelectorAll(".price-input input")
        progress = document.querySelector(".slider .progress");

        $(document).ready(function() {
            updateSlider();
        });

        let priceGap = 40000;

        priceInput.forEach(input => {
            input.addEventListener("input", e =>{
                let minVal = parseInt(priceInput[0].value),
                maxVal = parseInt(priceInput[1].value);

                if(maxVal - minVal >= priceGap){
                    if(e.target.className === 'input-min'){
                        rangeInput[0].value = minVal;
                        progress.style.left = (minVal / rangeInput[0].max) * 100 + '%';
                    }else{
                        rangeInput[1].value = maxVal;
                        progress.style.right = 100 - (maxVal / rangeInput[0].max) * 100 + '%';
                    }
                }else{
                }
            });
        });

        rangeInput.forEach(input => {
            input.addEventListener("input", e =>{
                let minVal = parseInt(rangeInput[0].value),
                maxVal = parseInt(rangeInput[1].value);

                if(maxVal - minVal < priceGap){
                    if(e.target.className === 'range-min'){
                        rangeInput[0].value = maxVal - priceGap;
                    }else{
                        rangeInput[1].value = minVal + priceGap;
                    }
                }else{
                    priceInput[0].value = minVal;
                    priceInput[1].value = maxVal;
                    progress.style.left = (minVal / rangeInput[0].max) * 100 + '%';
                    progress.style.right = 100 - (maxVal / rangeInput[0].max) * 100 + '%';
                }
            });
        });
        function updateSlider() {
            let minVal = parseInt(rangeInput[0].value),
                maxVal = parseInt(rangeInput[1].value);

            progress.style.left = (minVal / rangeInput[0].max) * 100 + '%';
            progress.style.right = 100 - (maxVal / rangeInput[0].max) * 100 + '%';
        }
    </script>
{% endblock %}